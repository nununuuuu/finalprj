# 量化交易策略回測系統

基於 FastAPI 與 Backtesting.py 的網頁式交易策略回測平台，支援多種技術指標與彈性策略組合。

---



## 目錄

1. [環境設定](#-環境設定)
2. [執行方法](#-執行方法)
3. [專案架構](#-專案架構)
4. [策略系統](#-策略系統)
5. [系統功能總覽](#-系統功能總覽)


---

## 環境設定說明

### 系統需求

- **Python**: 3.12 或以上
- **套件管理**: `uv`
- **作業系統**: Windows / macOS / Linux

### 安裝 uv 套件管理工具

```bash
# Windows (PowerShell)
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# macOS / Linux
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### 安裝專案依賴

```bash
# 使用 uv
uv sync
```

### 核心依賴套件

| 套件 | 版本 | 用途 |
|------|------|------|
| **fastapi** | ≥0.115.6 | Web 框架 |
| **backtesting** | ≥0.3.3 | 回測引擎 |
| **pandas** | ≥2.2.3 | 數據處理 |
| **pydantic** | ≥2.10.4 | 資料驗證 |
| **uvicorn** | ≥0.34.0 | ASGI 伺服器 |
| **yfinance** | ≥0.2.51 | 金融數據下載 |
| **jinja2** | ≥3.1.5 | 模板引擎 |

---

## 執行方法

### 方法一：使用 run.py (推薦)

最簡單的啟動方式，會自動開啟瀏覽器：

```bash
# 使用 uv
uv run python run.py

# 或直接執行
python run.py
```

執行後會自動：
1. 啟動 FastAPI 伺服器 (http://127.0.0.1:8000)
2. 開啟預設瀏覽器並導向儀表板頁面

### 方法二：使用 uvicorn 手動啟動

```bash
# 使用 uv
uv run uvicorn app.main:app --reload

# 或在虛擬環境中
uvicorn app.main:app --reload
```

然後手動開啟瀏覽器，前往 `http://127.0.0.1:8000`

### 停止伺服器

在終端機按 `Ctrl + C` 即可停止伺服器。

---

## 專案架構

### 目錄結構

```
prj/
├── app/                      後端應用程式
│   ├── __init__.py           套件初始化
│   ├── main.py               FastAPI 主程式
│   │                          - API 路由定義
│   │                          - 數據下載與清洗
│   │                          - 回測執行邏輯
│   │                          - 績效指標計算
│   ├── strategy.py           通用策略系統
│   │                          - UniversalStrategy 類別
│   │                          - 技術指標函數庫 (SMA, RSI, MACD, KD, BBANDS, WILLR, Donchian)
│   │                          - 彈性訊號組合邏輯
│   └── schemas.py            Pydantic 資料模型
│                              - BacktestRequest (請求參數)
│                              - BacktestResponse (回測結果)
├── templates/                Jinja2 前端模板
│   ├── base.html             基礎模板 (CSS 設計系統)
│   └── dashboard.html        儀表板主頁面
│                              - 模式切換
│                              - 參數表單
│                              - 結果展示區
│                              - Chart.js 圖表
├── static/                   靜態資源
│   └── js/
│       └── main.js           前端邏輯
│                              - 表單提交與驗證
│                              - 圖表繪製 (資金曲線、熱力圖、回撤風險圖、損益分佈圖)
│                              - 數據格式化
├── data/                     歷史數據 (自動生成)
│   └── *.csv                 從 Yahoo Finance 下載的股票數據
├── run.py                    快速啟動腳本
├── pyproject.toml            專案設定檔
├── uv.lock                   套件版本鎖定檔
├── finalprj.md               期末專案需求說明
├── strategy.md               策略詳細說明文件
└── README.md                 說明文件
```

---

## 策略系統

### 三大模式設計

本專案採用 **UniversalStrategy** 通用策略架構，支援三種使用模式，滿足不同投資需求：

#### 1. 預設模式
**適合對象**: 快速測試

**預設策略**: 雙均線趨勢策略 + RSI 動能過濾

**策略選用原因**:
這是一個結合「趨勢追蹤」與「動能指標」的經典組合，能有效解決單一指標的盲點：
1. **趨勢確認 (SMA)**: 移動平均線負責判斷大方向，確保是順勢操作。
2. **避免追高 (RSI Filter)**: 單純的均線交叉有時會發生在價格已經漲很多的末升段。加入 RSI < 70 限制，強制我們只在「價格尚未過熱」時進場，提高安全邊際。
3. **提早獲利 (RSI Exit)**: 均線是落後指標，出場反應較慢。當市場短線暴漲 (RSI > 80) 時，利用 RSI 訊號提早獲利了結，避免等待均線死亡交叉時獲利已大幅回吐。

**進場條件** (AND 邏輯，需全部成立):
1. **黃金交叉**: 短期均線 (預設 10 日) 突破長期均線 (預設 60 日)
2. **RSI 過濾**: 進場 RSI < 70 (安全區間進場，避免追高)

**出場條件** (OR 邏輯，任一成立即出場):
1. **死亡交叉**: 短期均線跌破長期均線
2. **RSI 過熱**: 出場 RSI > 80 (情緒過熱，獲利了結)
3. **停損/停利**: 觸發預設的百分比停損或停利
4. **追蹤停損**: 啟動移動停損保護獲利

**可調參數**:
- 短/長期均線週期
- 進場/出場 RSI 週期與閾值
- 停損/停利/追蹤停損百分比

#### 2. 定期定額模式

**適合對象**: 存股族、長期投資者

**核心特色**: 真實模擬定期定額投資的現金流與成本。

**運作機制**:
- **定期入金**: 每月指定日期 (如 6 號) 自動轉入固定金額。
- **費用扣除**: 每次入金/交易時自動扣除設定的手續費 (真實反映存股成本)。
- **自動買進**: 扣費後將剩餘資金以當日收盤價盡量買入。
- **餘額累積**: 不足買一股的零股資金保留在帳戶，與下月資金合併使用。

#### 3. 自定義模式

**適合對象**: 進階使用者、策略研究

**特色**: 高度彈性的策略組裝工廠，不寫程式也能測試複雜策略。

**運作邏輯**:
- 支援多種訊號源並聯 (OR Logic)。
- 使用者可自由添加多個進場/出場條件，只要滿足其中之一即觸發訊號。

**支援技術指標**:
- **SMA**: 簡單移動平均線
```python
SMA(values, n)
```
- **RSI**: 相對強弱指標
```python
RSI(values, n=14)
```
- **MACD**: 指數平滑異同移動平均線
```python
MACD(values, fast=12, slow=26, signal=9)
```
- **KD**: 隨機指標
```python
KD(high, low, close, n=9)
```
- **BBANDS**: 布林通道
```python
BBANDS(values, n=20, std=2)
```
- **WILLR**: 威廉指標
```python
WILLR(high, low, close, n=14)
```
- **Donchian**: 海龜通道 (Donchian Channel)
```python
donchian_channel(high, low, close, n=20)
```

---

## 系統功能總覽

本系統整合了策略開發、數據抓取與績效分析，提供一站式的量化交易研究環境：

1.  **多模式回測引擎**:
    *   提供 **預設模式**、**定期定額模式** 與 **自定義模式** 三種模式，各種程度的使用者都能上手。
2.  **自動化數據抓取**:
    *   只需輸入股票代碼 (如 AAPL, 2330.TW)，系統自動從 Yahoo Finance 下載最新歷史數據，無需手動整理 CSV。
3.  **視覺化圖表**:
    *   **資金曲線圖**: 清楚比較「策略績效」與「買入持有」的差異。
    *   **月度熱力圖**: 用顏色深淺直觀呈現每個月的獲利狀況，一眼看出策略在淡旺季的表現。
    *   **回撤風險圖**: 呈現資產從高點回落的幅度 (Underwater Plot)，幫助了解策略面臨的最大壓力和風險。
    *   **損益分佈圖**: 統計每筆交易的盈虧分佈，快速掌握策略是靠「高勝率」還是「大賺小賠」獲利。
    *   **績效指標區**
        *   **總報酬率 (Total Return)**: 策略在回測期間的總獲利百分比。
        *   **年化報酬率 (CAGR)**: 將總報酬換算成每年的平均複利報酬，方便與銀行定存或其他商品比較。
        *   **買入持有報酬 (Buy & Hold Return)**: 若「第一天買進後就不動」的獲利表現，用來當作評估策略好壞的基準 (Benchmark)。
        *   **最大回撤 (Max Drawdown)**: 資產從最高點回落的最大幅度。數值越小代表風險越低，是評估「抗跌能力」的關鍵指標。
        *   **夏普比率 (Sharpe Ratio)**: 衡量「每承擔一單位風險能獲得多少報酬」。大於 1 代表表現優異，小於 0 代表不如定存。
        *   **獲利因子 (Profit Factor)**: 總獲利金額除以總虧損金額。大於 1.5 通常被視為一個健康的策略。
        *   **勝率 (Win Rate)**: 獲利交易筆數佔總交易筆數的比例。需注意「高勝率不代表一定賺錢」(可能小賺大賠)。
4.  **詳細交易紀錄**:
    *   列出每一筆進出場的時間、價格、損益，方便逐筆檢討策略邏輯。

---



